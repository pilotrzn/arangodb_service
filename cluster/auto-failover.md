# Automatic failover 

### Сбой последователя

Если DB-сервер, на котором хранится копия последователя сегмента, выходит из строя, лидер больше не может синхронизировать свои изменения с этим последователем. После короткого тайм-аута (3 секунды) лидер отказывается от последователя и объявляет, что он не синхронизирован.

Может произойти один из следующих двух случаев:

- Если в Кластере доступен другой сервер БД (который еще не содержит реплики для этого сегмента), этот сервер становится подписчиком(таким образом, ограничение фактора репликации снова выполняется).

- Если ни один другой DB-сервер (который уже не содержит реплики для этого сегмента) не доступен, служба продолжается с одним подписчиком меньше, чем число, предписанное коэффициентом репликации.

Если возвращается старый DB-сервер с последующей копией, может произойти один из следующих двух случаев:

- Следуя первому примеру, DB-Server распознает, что есть новый подписчик, который был выбран за это время, поэтому он больше не является подписчиком для этого сегмента.

- Во втором случае сервер БД автоматически повторно синхронизирует свои данные с лидером. Теперь ограничение фактора репликации снова выполнено, и порядок восстановлен.


### Сбой лидера

Если DB-сервер, являющийся лидером, выходит из строя, лидер больше не может обслуживать какие-либо запросы. Он больше не отправляет heartbeats Агентству. Таким образом, процесс наблюдения, запущенный в Raft leader Агентства, может предпринять необходимые действия (после 15 секунд пропущенных heartbeats), а именно продвижение(promote) одного из DB-серверов в лидеры. Это предполагает перенастройку в Агентстве и приводит к тому, что Координаторы теперь обращаются к другому DB-серверу для запросов к этому сегменту. Служба возобновляется. Остальные реплики автоматически повторно синхронизируют свои данные с новым лидером.

В дополнение к вышесказанному, может произойти один из следующих двух случаев:

- А: Если в Кластере доступен другой сервер БД (который еще не содержит реплики для этого сегмента), на этом другом сервере БД автоматически создается новый подписчик (таким образом, ограничение фактора репликации снова выполняется).

- B: Если ни один другой DB-сервер (который уже не содержит реплики для этого сегмента) не доступен, служба продолжается с одним подписчиком меньше, чем число, предписанное коэффициентом репликации.

Когда DB-Server возвращается старый лидер, он распознает, что за это время был избран новый лидер, и может произойти один из следующих двух случаев:

- Следуя примеру A, поскольку также был создан новый последователь и выполнено ограничение фактора репликации, DB-Server больше не является последователем для этого сегмента.

- Следуя примеру B, сервер БД замечает, что теперь он содержит реплику-последователя этого сегмента, и повторно синхронизирует свои данные с новым лидером. Ограничение фактора репликации снова выполняется, и порядок восстанавливается.